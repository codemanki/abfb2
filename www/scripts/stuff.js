define(
    [],
  function(){
        var debug = 1;
        return {
                 pick:function(arg, def) {
                            return (typeof arg == 'undefined' ? def : arg);
                 },
                 get_type:function(obj){
                         Object.prototype.toString.call(obj).replace(/^\[object (.+)\]$/,"$1").toLowerCase();
                 },
                 log:function(object){
                    if(debug===1) console.log(object);
                 },
                getStyle:function(el,styleProp) { //http://stackoverflow.com/questions/1955048/get-computed-font-size-for-dom-element-in-js
                  var camelize = function (str) {
                    return str.replace(/\-(\w)/g, function(str, letter){
                      return letter.toUpperCase();
                    });
                  };

                  if (el.currentStyle) {
                    return el.currentStyle[camelize(styleProp)];
                  } else if (document.defaultView && document.defaultView.getComputedStyle) {
                    return document.defaultView.getComputedStyle(el,null)
                                               .getPropertyValue(styleProp);
                  } else {
                    return el.style[camelize(styleProp)]; 
                  }
                },
                 sndimg:"data:image/svg+xml;base64,PCEtLSBDcmVhdGVkIHdpdGggSW5rc2NhcGUgKGh0dHA6Ly93d3cuaW5rc2NhcGUub3JnLykgLS0+CjxzdmcgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB2aWV3Qm94PSIwIDAgMTUwIDE1MCI+CiA8bWV0YWRhdGE+CiAgPHJkZjpSREY+CiAgIDxjYzpXb3JrIHJkZjphYm91dD0iIj4KICAgIDxkYzpmb3JtYXQ+aW1hZ2Uvc3ZnK3htbDwvZGM6Zm9ybWF0PgogICAgPGRjOnR5cGUgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIvPgogICAgPGRjOnRpdGxlLz4KICAgPC9jYzpXb3JrPgogIDwvcmRmOlJERj4KIDwvbWV0YWRhdGE+CiA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNjIuNjc4ODMsLTI5Ni4zNjgyMSkiPgogIDxnIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS1kYXNob2Zmc2V0PSIwIiB0cmFuc2Zvcm09Im1hdHJpeCgwLC0xLDEsMCwtMjMzLjUwNiw1MDcuMjU3MykiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtZGFzaGFycmF5PSJub25lIiBzdHJva2UtbWl0ZXJsaW1pdD0iNCIgZmlsbD0ibm9uZSI+CiAgIDxwYXRoIGQ9Im0xNDAsMzAwLDY2LDc2LTEzMCwweiIgc3Ryb2tlLXdpZHRoPSI1LjIiLz4KICAgPHBhdGggZD0ibTM5MCw1NTBjLTM4LDUzLTEyMCw2OC0xODAsMzQtMTUtOC45LTI4LTIxLTM4LTM0IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjY0ODUsMCwwLDAuMjgxLC00OC4zNjYzLDI3MikiIHN0cm9rZS13aWR0aD0iMTQuMTgyNjEzMzciLz4KICAgPHBhdGggZD0ibTM5MCw1NTBjLTM4LDUzLTEyMCw2OC0xODAsMzQtMTUtOC45LTI4LTIxLTM4LTM0IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjUyNywwLDAsMC4zNTUsLTEzLjU2MTMzLDIxNC4zKSIgc3Ryb2tlLXdpZHRoPSIxMy42NTIwNyIvPgogICA8cGF0aCBkPSJtMzkwLDU1MGMtMzgsNTMtMTIwLDY4LTE4MCwzNC0xNS04LjktMjgtMjEtMzgtMzQiIHRyYW5zZm9ybT0ibWF0cml4KDAuNDI0NzMxNTEsMCwwLDAuMzgsMTUuNTQ2LDE4NC43KSIgc3Ryb2tlLXdpZHRoPSIxNi45OTk5MTk4OSIvPgogIDwvZz4KIDwvZz4KPC9zdmc+Cg==",
                 tocxsl:"<xsl:stylesheet version=&quot;1.0&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot; exclude-result-prefixes=&quot;ncx xsl&quot; xmlns:ncx=&quot;http://www.daisy.org/z3986/2005/ncx/&quot; xmlns:epub=&quot;http://www.idpf.org/2007/ops&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;> <xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/> <xsl:param name=&quot;contents-str&quot;>Contents</xsl:param> <xsl:template match=&quot;ncx:ncx&quot;> <xsl:call-template name=&quot;html-head&quot;/> <select id=&quot;tocselect&quot;> <xsl:apply-templates/> </select> </xsl:template> <xsl:template match=&quot;ncx:navMap&quot;> <!--h1><xsl:value-of select=&quot;$contents-str&quot;/></h1--> <xsl:apply-templates/> </xsl:template> <xsl:template match=&quot;ncx:navPoint&quot;> <option style=&quot;text-indent:{16*count(ancestor::*)}px&quot;> <xsl:attribute name=&quot;id&quot;> <xsl:value-of select=&quot;@playOrder&quot;/> </xsl:attribute> <xsl:attribute name=&quot;url&quot;> <xsl:apply-templates select=&quot;ncx:content&quot;/> </xsl:attribute> <xsl:value-of select=&quot;ncx:navLabel&quot;/> </option> <xsl:apply-templates select=&quot;ncx:navPoint&quot;/> </xsl:template> <xsl:template match=&quot;ncx:content&quot;> <xsl:apply-templates select=&quot;@src&quot;/> </xsl:template> <xsl:template match=&quot;ncx:navLabel| ncx:text&quot;> <xsl:apply-templates/> </xsl:template> <xsl:template match=&quot;ncx:head| ncx:docAuthor| ncx:docTitle&quot;/> <xsl:template match=&quot;ncx:head/text()| ncx:docAuthor/text()| ncx:docTitle/text()| ncx:navLabel/text()&quot;/> <xsl:template match=&quot;*&quot;> <xsl:message terminate=&quot;yes&quot;>ERROR: <xsl:value-of select=&quot;name(.)&quot;/> not matched! </xsl:message> </xsl:template> <xsl:template name=&quot;html-head&quot;> <h1><xsl:apply-templates select=&quot;/ncx:ncx/ncx:docTitle/ncx:text&quot;/></h1> </xsl:template> </xsl:stylesheet>",
                fb2xsl:"<xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xmlns:fb=&quot;http://www.gribuser.ru/xml/fictionbook/2.0&quot;> <xsl:output method=&quot;html&quot; encoding=&quot;UTF-8&quot;/> <xsl:key name=&quot;note-link&quot; match=&quot;fb:section&quot; use=&quot;@id&quot;/> <xsl:template match=&quot;/*&quot;> <h4 align=&quot;center&quot;> <xsl:value-of select=&quot;fb:description/fb:title-info/fb:book-title&quot;/> </h4> <xsl:for-each select=&quot;fb:description/fb:title-info/fb:coverpage/fb:image&quot;> <xsl:call-template name=&quot;image&quot;/> </xsl:for-each> <xsl:for-each select=&quot;fb:description/fb:title-info/fb:annotation&quot;> <div> <xsl:call-template name=&quot;annotation&quot;/> </div> <hr/> </xsl:for-each> <!-- BUILD TOC --> <select id=&quot;fb2toc&quot;> <xsl:apply-templates select=&quot;fb:body&quot; mode=&quot;toc&quot;/> </select> <hr/> <!-- BUILD BOOK --> <xsl:for-each select=&quot;fb:body&quot;> <xsl:if test=&quot;position()!=1&quot;> <hr/> </xsl:if> <xsl:if test=&quot;@name&quot;> <h4 align=&quot;center&quot;> <xsl:value-of select=&quot;@name&quot;/> </h4> </xsl:if> <!-- <xsl:apply-templates /> --> <xsl:apply-templates/> </xsl:for-each> </xsl:template> <!-- author template --> <xsl:template name=&quot;author&quot;> <xsl:value-of select=&quot;fb:first-name&quot;/> <xsl:text disable-output-escaping=&quot;no&quot;>&#032;</xsl:text> <xsl:value-of select=&quot;fb:middle-name&quot;/>&#032; <xsl:text disable-output-escaping=&quot;no&quot;>&#032;</xsl:text> <xsl:value-of select=&quot;fb:last-name&quot;/> <br/> </xsl:template> <!-- secuence template --> <xsl:template name=&quot;sequence&quot;> <LI/> <xsl:value-of select=&quot;@name&quot;/> <xsl:if test=&quot;@number&quot;> <xsl:text disable-output-escaping=&quot;no&quot;>,&#032;#</xsl:text> <xsl:value-of select=&quot;@number&quot;/> </xsl:if> <xsl:if test=&quot;fb:sequence&quot;> <ul> <xsl:for-each select=&quot;fb:sequence&quot;> <xsl:call-template name=&quot;sequence&quot;/> </xsl:for-each> </ul> </xsl:if> <!-- <br/> --> </xsl:template> <!-- toc template --> <xsl:template match=&quot;fb:section|fb:body&quot; mode=&quot;toc&quot;> <xsl:choose> <xsl:when test=&quot;name()=&apos;body&apos; and position()=1 and not(fb:title)&quot;> <xsl:apply-templates select=&quot;fb:section&quot; mode=&quot;toc&quot;/> </xsl:when> <xsl:otherwise> <option style=&quot;text-indent:{16*count(ancestor::*)}px&quot; did=&quot;TOC_{generate-id()}&quot;> <!--a href=&quot;#TOC_{generate-id()}&quot;></a--> <xsl:value-of select=&quot;normalize-space(fb:title/fb:p[1] | @name)&quot;/> </option> <xsl:if test=&quot;fb:section&quot;> <xsl:apply-templates select=&quot;fb:section&quot; mode=&quot;toc&quot;/> </xsl:if> </xsl:otherwise> </xsl:choose> </xsl:template> <!-- description --> <xsl:template match=&quot;fb:description&quot;> <xsl:apply-templates/> </xsl:template> <!-- body --> <xsl:template match=&quot;fb:body&quot;> <div><xsl:apply-templates/></div> </xsl:template> <xsl:template match=&quot;fb:section&quot;> <div id=&quot;TOC_{generate-id()}&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates select=&quot;*[not(self::fb:section)]&quot;/> </div> <xsl:apply-templates select=&quot;fb:section&quot;/> </xsl:template> <!-- section/title --> <xsl:template match=&quot;fb:section/fb:title|fb:poem/fb:title&quot;> <xsl:choose> <xsl:when test=&quot;count(ancestor::node()) &lt; 9&quot;> <xsl:element name=&quot;{concat(&apos;h&apos;,count(ancestor::node())-3)}&quot;> <!--a name=&quot;TOC_{generate-id()}&quot;></a--> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/> </xsl:element> </xsl:when> <xsl:otherwise> <xsl:element name=&quot;h6&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/> </xsl:element> </xsl:otherwise> </xsl:choose> </xsl:template> <!-- section/title --> <xsl:template match=&quot;fb:body/fb:title&quot;> <h1><xsl:apply-templates mode=&quot;title&quot;/></h1> </xsl:template> <xsl:template match=&quot;fb:title/fb:p&quot;> <xsl:apply-templates/><xsl:text disable-output-escaping=&quot;no&quot;>&#032;</xsl:text><br/> </xsl:template> <!-- subtitle --> <xsl:template match=&quot;fb:subtitle&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <h5> <xsl:apply-templates/> </h5> </xsl:template> <!-- p --> <xsl:template match=&quot;fb:p&quot;> <div align=&quot;justify&quot;><xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> &#160;&#160;&#160;<xsl:apply-templates/></div> </xsl:template> <!-- strong --> <xsl:template match=&quot;fb:strong&quot;> <b><xsl:apply-templates/></b> </xsl:template> <!-- emphasis --> <xsl:template match=&quot;fb:emphasis&quot;> <i> <xsl:apply-templates/></i> </xsl:template> <!-- style --> <xsl:template match=&quot;fb:style&quot;> <span class=&quot;{@name}&quot;><xsl:apply-templates/></span> </xsl:template> <!-- empty-line --> <xsl:template match=&quot;fb:empty-line&quot;> <br/> </xsl:template> <!-- link --> <xsl:template match=&quot;fb:a&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;href&quot;><xsl:value-of select=&quot;@xlink:href&quot;/></xsl:attribute> <xsl:attribute name=&quot;title&quot;> <xsl:choose> <xsl:when test=&quot;starts-with(@xlink:href,&apos;#&apos;)&quot;><xsl:value-of select=&quot;key(&apos;note-link&apos;,substring-after(@xlink:href,&apos;#&apos;))/fb:p&quot;/></xsl:when> <xsl:otherwise><xsl:value-of select=&quot;key(&apos;note-link&apos;,@xlink:href)/fb:p&quot;/></xsl:otherwise> </xsl:choose> </xsl:attribute> <xsl:choose> <xsl:when test=&quot;(@type) = &apos;note&apos;&quot;> <sup> <xsl:apply-templates/> </sup> </xsl:when> <xsl:otherwise> <xsl:apply-templates/> </xsl:otherwise> </xsl:choose> </xsl:element> </xsl:template> <!-- annotation --> <xsl:template name=&quot;annotation&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <h3>Annotation</h3> <xsl:apply-templates/> </xsl:template> <!-- epigraph --> <xsl:template match=&quot;fb:epigraph&quot;> <blockquote class=&quot;epigraph&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/> </blockquote> </xsl:template> <!-- epigraph/text-author --> <xsl:template match=&quot;fb:epigraph/fb:text-author&quot;> <blockquote> <i><xsl:apply-templates/></i> </blockquote> </xsl:template> <!-- cite --> <xsl:template match=&quot;fb:cite&quot;> <blockquote> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/> </blockquote> </xsl:template> <!-- cite/text-author --> <xsl:template match=&quot;fb:text-author&quot;> <blockquote> <i> <xsl:apply-templates/></i></blockquote> </xsl:template> <!-- date --> <xsl:template match=&quot;fb:date&quot;> <xsl:choose> <xsl:when test=&quot;not(@value)&quot;> &#160;&#160;&#160;<xsl:apply-templates/> <br/> </xsl:when> <xsl:otherwise> &#160;&#160;&#160;<xsl:value-of select=&quot;@value&quot;/> <br/> </xsl:otherwise> </xsl:choose> </xsl:template> <!-- poem --> <xsl:template match=&quot;fb:poem&quot;> <blockquote> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/> </blockquote> </xsl:template> <!-- stanza --> <xsl:template match=&quot;fb:stanza&quot;> <xsl:apply-templates/> <br/> </xsl:template> <!-- v --> <xsl:template match=&quot;fb:v&quot;> <xsl:if test=&quot;@id&quot;> <xsl:element name=&quot;a&quot;> <xsl:attribute name=&quot;name&quot;><xsl:value-of select=&quot;@id&quot;/></xsl:attribute> </xsl:element> </xsl:if> <xsl:apply-templates/><br/> </xsl:template> <!-- image --> <xsl:template match=&quot;fb:image&quot; name=&quot;image&quot;> <div align=&quot;center&quot;> <img border=&quot;1&quot;> <xsl:choose> <xsl:when test=&quot;starts-with(@xlink:href,&apos;#&apos;)&quot;> <xsl:attribute name=&quot;src&quot;><xsl:text>data:</xsl:text><xsl:variable name=&quot;href&quot; select=&quot;substring-after(@xlink:href,&apos;#&apos;)&quot; /><set variable=&quot;href&quot; expression=&quot;substring-after(@xlink:href,&apos;#&apos;)&quot;/><xsl:value-of select=&quot;//fb:binary[@id=$href]/@content-type&quot; disable-output-escaping=&quot;yes&quot; /><xsl:text>;base64,</xsl:text><!--<xsl:value-of select=&quot;substring-after(@xlink:href,&apos;#&apos;)&quot;/>--><xsl:value-of select=&quot;//fb:binary[@id=$href]&quot; disable-output-escaping=&quot;yes&quot;/></xsl:attribute> </xsl:when> <xsl:otherwise> <xsl:attribute name=&quot;src&quot;><xsl:value-of select=&quot;@xlink:href&quot;/></xsl:attribute> </xsl:otherwise> </xsl:choose> </img> </div> </xsl:template> </xsl:stylesheet>"
        }
  }
);
